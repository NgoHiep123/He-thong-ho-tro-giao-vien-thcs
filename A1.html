<!DOCTYPE html>
<html lang="vi">
<head>
  <title>Trắc Nghiệm: A1 – Thiết bị vào-ra cơ bản</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif}
    .option-btn:disabled{cursor:not-allowed}
    .correct{background-color:#22c55e!important;color:#fff!important;border-color:#16a34a!important}
    .incorrect{background-color:#ef4444!important;color:#fff!important;border-color:#dc2626!important}
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">

  <!-- Top bar -->
  <header class="sticky top-0 z-20 backdrop-blur bg-white/70 dark:bg-gray-900/70 border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="inline-flex items-center gap-2 text-gray-700 dark:text-gray-200 hover:opacity-80">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 19V6M5 11l5-5 5 5"/></svg>
        <span class="font-semibold">Trang chủ</span>
      </a>
      <div class="flex items-center gap-2">
        <span id="userPill" class="hidden md:inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-indigo-50 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-200 border border-indigo-100 dark:border-indigo-800"></span>
        <button id="logoutBtn" class="hidden px-3 py-1.5 rounded-lg text-sm font-semibold border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800">Đăng xuất</button>
      </div>
    </div>
  </header>

  <main class="px-4 py-6 flex justify-center">
    <div id="quiz-container" class="w-full max-w-3xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 md:p-8">

      <!-- Header -->
      <div class="text-center mb-5">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">
          Trắc nghiệm: A1 – Thiết bị vào-ra cơ bản
        </h1>
        <p class="text-gray-500 dark:text-gray-400 mt-2">
          Chọn đáp án đúng nhất cho mỗi câu hỏi. Bài gồm 10 câu.
        </p>
      </div>

      <!-- Progress / Score -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <div id="progress" class="text-gray-700 dark:text-gray-300 font-medium">Câu hỏi 1 / 10</div>
        <div class="flex items-center gap-2">
          <div class="w-40 h-2 rounded bg-gray-200 dark:bg-gray-700 overflow-hidden">
            <div id="bar" class="h-full bg-blue-500 transition-all duration-300" style="width:10%"></div>
          </div>
          <div id="score" class="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full font-semibold">
            Điểm: 0
          </div>
        </div>
      </div>

      <!-- Question -->
      <div id="question-card" class="bg-gray-50 dark:bg-gray-700 p-5 rounded-xl mb-4 min-h-[90px] flex items-center justify-center">
        <p id="question-text" class="text-center text-lg font-semibold text-gray-900 dark:text-white"></p>
      </div>

      <!-- Options -->
      <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

      <!-- Feedback -->
      <div id="feedback-container" class="mt-4 text-center min-h-[24px]">
        <p id="feedback-text" class="font-medium"></p>
      </div>

      <!-- Next -->
      <div class="mt-3 flex justify-end">
        <button id="next-btn" class="hidden w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
          Câu tiếp theo
        </button>
      </div>

      <!-- Results -->
      <div id="results-container" class="hidden text-center">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Hoàn thành!</h2>
        <p class="text-gray-600 dark:text-gray-400 mt-2">Kết quả của bạn:</p>
        <div class="my-6">
          <p class="text-5xl font-bold text-blue-600" id="final-score"></p>
          <p class="text-lg text-gray-700 dark:text-gray-300 mt-2" id="score-comment"></p>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" id="send-status">Đang gửi kết quả…</p>
        </div>
        <div class="flex gap-3 justify-center">
          <a href="index.html" class="px-5 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold">Trang chủ</a>
          <button id="restart-btn" class="px-6 py-3 rounded-lg bg-green-500 text-white font-bold hover:bg-green-600 transition-colors duration-300 shadow-lg">Làm lại</button>
        </div>
      </div>

    </div>
  </main>

  <script>
    // ===== Cấu hình =====
    const QUIZ_ID = "A1";
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbwj9IiX8PXC-bNsh4DGIw0uysx0v3jWPNeu0lQpieUIQAx9sT9YNUKTZoQFBjg-w86TKg/exec";

    // Lấy thông tin học sinh từ localStorage (nếu có)
    function getStudent(){
      try { return JSON.parse(localStorage.getItem('student')||'null'); }
      catch(e){ return null; }
    }
    const student = getStudent();

    // Hiển thị user + logout
    (function setupUserUI(){
      const pill = document.getElementById('userPill');
      const logoutBtn = document.getElementById('logoutBtn');
      if(student){
        if(pill){
          pill.classList.remove('hidden');
          pill.textContent = `Xin chào, ${student.name} · Lớp ${student.className}`;
        }
        if(logoutBtn){
          logoutBtn.classList.remove('hidden');
          logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('student');
            location.href = 'index.html';
          });
        }
      }
    })();

    // ===== Dữ liệu câu hỏi =====
    const quizData = [
      {question: "Một bộ máy tính để bàn gồm các thành phần cơ bản nào?", options: ["Hộp thân máy, màn hình, bàn phím, chuột.", "Màn hình, loa, micro, camera.", "CPU, RAM, ổ cứng, loa.", "Màn hình, bàn phím, máy in, chuột."], answer: 0},
      {question: "Thiết bị nào sau đây là thiết bị vào cơ bản?", options: ["Màn hình.", "Loa.", "Bàn phím.", "Ổ đĩa cứng."], answer: 2},
      {question: "Màn hình thuộc loại thiết bị nào của máy tính?", options: ["Thiết bị vào.", "Thiết bị ra.", "Thiết bị lưu trữ.", "Thiết bị xử lí."], answer: 1},
      {question: "Hộp thân máy thường chứa các thành phần quan trọng nào?", options: ["CPU, RAM, ổ đĩa cứng.", "Màn hình, bàn phím, chuột.", "Loa, micro, camera.", "Card mạng, máy in, máy quét."], answer: 0},
      {question: "Máy tính xách tay thường có sẵn những thiết bị hỗ trợ âm thanh/hình ảnh nào?", options: ["Loa.", "Micro.", "Camera.", "Cả 3 đúng."], answer: 3},
      {question: "Vì sao màn hình cảm ứng được xem là “vừa là thiết bị vào, vừa là thiết bị ra”?", options: ["Chỉ hiển thị hình ảnh.", "Chỉ nhận lệnh chạm.", "Vừa hiển thị (ra) vừa nhận thao tác chạm/nhập liệu (vào).", "Vừa lưu trữ dữ liệu vừa xử lí."], answer: 2},
      {question: "Chọn nhận định đúng về bố trí thiết bị vào – ra giữa máy tính để bàn và máy tính xách tay:", options: ["Máy để bàn tích hợp tất cả; laptop tách rời.", "Cả hai đều tách rời toàn bộ.", "Máy để bàn tách rời; laptop tích hợp, và laptop dùng tấm chạm thay chuột.", "Laptop không có màn hình."], answer: 2},
      {question: "Ổ đĩa cứng chủ yếu dùng để làm gì?", options: ["Xử lí dữ liệu.", "Hiển thị kết quả.", "Lưu phần mềm hệ thống, ứng dụng và tệp dữ liệu.", "Phát âm thanh."], answer: 2},
      {question: "Bạn có máy tính để bàn (hộp thân máy, màn hình, bàn phím, chuột). Để học trực tuyến (nghe–nói–nhìn), cần bổ sung tối thiểu gì?", options: ["Card mạng rời.", "Webcam và loa/tai nghe kèm micro.", "Ổ cứng ngoài.", "Máy in."], answer: 1},
      {question: "Trên máy tính bảng/điện thoại thông minh, thiết bị nào vừa là đầu vào vừa là đầu ra?", options: ["Loa.", "Micro.", "Màn hình cảm ứng.", "Ổ đĩa cứng."], answer: 2}
    ];

    // ===== Trợ năng =====
    function announce(el, msg, color){ el.textContent = msg; el.style.color = color; }

    // ===== Xáo trộn =====
    function shuffle(arr){ for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
    function withShuffledOptions(q){
      const order = q.options.map((_, i) => i);
      shuffle(order);
      const options = order.map(i => q.options[i]);
      const answer = order.indexOf(q.answer);
      return { ...q, options, answer };
    }

    // ===== DOM =====
    const mainGameContainer = document.getElementById('quiz-container');
    const resultsContainer = document.getElementById('results-container');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const feedbackText = document.getElementById('feedback-text');
    const nextBtn = document.getElementById('next-btn');
    const restartBtn = document.getElementById('restart-btn');
    const progressText = document.getElementById('progress');
    const scoreText = document.getElementById('score');
    const finalScoreText = document.getElementById('final-score');
    const scoreCommentText = document.getElementById('score-comment');
    const sendStatus = document.getElementById('send-status');
    const bar = document.getElementById('bar');

    // ===== State =====
    let currentQuestionIndex = 0;
    let score = 0;
    let shuffledQuestions = [];
    let chosen = [];

    function startGame(){
      currentQuestionIndex = 0;
      score = 0;
      const prepared = quizData.map(withShuffledOptions);
      shuffledQuestions = shuffle(prepared.slice());
      chosen = new Array(shuffledQuestions.length).fill(null);
      updateScoreDisplay();
      loadQuestion();
    }

    function loadQuestion(){
      feedbackText.textContent = '';
      nextBtn.classList.add('hidden');
      optionsContainer.innerHTML = '';

      const total = shuffledQuestions.length;
      const current = shuffledQuestions[currentQuestionIndex];
      questionText.textContent = current.question;
      progressText.textContent = `Câu hỏi ${currentQuestionIndex + 1} / ${total}`;
      bar.style.width = `${(currentQuestionIndex + 1) / total * 100}%`;

      current.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option;
        button.className = 'option-btn w-full text-left p-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200 text-gray-700 dark:text-gray-200';
        button.dataset.index = index;
        button.addEventListener('click', selectAnswer);
        optionsContainer.appendChild(button);
      });
    }

    function selectAnswer(e){
      const btn = e.target;
      const selectedIndex = parseInt(btn.dataset.index);
      const correctIndex = shuffledQuestions[currentQuestionIndex].answer;

      Array.from(optionsContainer.children).forEach(b => b.disabled = true);
      chosen[currentQuestionIndex] = selectedIndex;

      if(selectedIndex === correctIndex){
        score += 10; updateScoreDisplay();
        btn.classList.add('correct');
        announce(feedbackText, 'Chính xác! Rất tốt!', '#22c55e');
      }else{
        btn.classList.add('incorrect');
        announce(feedbackText, 'Tiếc quá, sai rồi!', '#ef4444');
        optionsContainer.children[correctIndex].classList.add('correct');
      }

      nextBtn.classList.remove('hidden');
      if(currentQuestionIndex === shuffledQuestions.length - 1) nextBtn.textContent = 'Xem kết quả';
      else nextBtn.textContent = 'Câu tiếp theo';
    }

    function nextQuestion(){
      currentQuestionIndex++;
      if(currentQuestionIndex < shuffledQuestions.length) loadQuestion();
      else showResults();
    }

    function showResults(){
      document.querySelector('#results-container').classList.remove('hidden');
      document.querySelector('#quiz-container > :not(#results-container)')?.classList.add('hidden');

      const total = shuffledQuestions.length;
      const percent = (score / (total * 10)) * 100;
      finalScoreText.textContent = `${score} / ${total * 10}`;
      if (percent === 100) scoreCommentText.textContent = 'Tuyệt vời! Bạn đã nắm vững kiến thức!';
      else if (percent >= 70) scoreCommentText.textContent = 'Làm tốt lắm! Bạn hiểu bài khá rõ.';
      else if (percent >= 50) scoreCommentText.textContent = 'Cố gắng hơn nhé! Hãy ôn lại bài một chút.';
      else scoreCommentText.textContent = 'Đừng nản lòng, hãy xem lại bài và thử lại nhé!';

      // Payload gửi – lấy tên/lớp từ localStorage (nếu có)
      const payload = {
        quizId: QUIZ_ID,
        name: student?.name || '',
        className: student?.className || '',
        score,
        total: total * 10,
        answers: shuffledQuestions.map((q, i) => ({
          q: i + 1,
          question: q.question,
          selectedIndex: chosen[i],
          selectedText: (typeof chosen[i] === 'number' && q.options[chosen[i]] !== undefined) ? q.options[chosen[i]] : null,
          correctIndex: q.answer,
          correctText: q.options[q.answer]
        }))
      };

      // Lưu tạm localStorage
      try{
        const key = 'quizResults';
        const old = JSON.parse(localStorage.getItem(key) || '[]');
        old.push({ ...payload, timestamp: new Date().toISOString() });
        localStorage.setItem(key, JSON.stringify(old));
      }catch(e){}

      // Gửi lên endpoint (no-cors)
      if (sendStatus) sendStatus.textContent = 'Đang gửi kết quả…';
      fetch(ENDPOINT, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(() => {
        if (sendStatus) sendStatus.textContent = 'Đã gửi kết quả (nếu kết nối ổn).';
      }).catch(() => {
        if (sendStatus) sendStatus.textContent = 'Không gửi được – đã lưu tạm trên máy.';
      });
    }

    function updateScoreDisplay(){ scoreText.textContent = `Điểm: ${score}`; }

    document.getElementById('next-btn').addEventListener('click', nextQuestion);
    document.getElementById('restart-btn')?.addEventListener('click', () => location.reload());

    // Khởi động
    (function init(){
      const prepared = quizData.map(withShuffledOptions);
      shuffledQuestions = shuffle(prepared.slice());
      chosen = new Array(shuffledQuestions.length).fill(null);
      updateScoreDisplay();
      loadQuestion();
    })();
  </script>
</body>
</html>
